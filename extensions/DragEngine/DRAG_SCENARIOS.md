# 拖动引擎场景分析文档

> 基于飞书文档和 Craft 的拖动行为研究

## 一、核心拖动原则

### 飞书文档的拖动规则
1. **整块拖动**：始终拖动完整的块结构（包括列表项、引用、代码块等）
2. **蓝线指示**：拖动时显示蓝色插入线，指示放置位置
3. **嵌套保持**：拖动嵌套内容时，保持原有层级结构
4. **智能插入**：根据目标区域类型，自动调整插入行为

### Craft 的拖动规则
1. **块级独立**：每个块都是独立的拖动单元
2. **区域感知**：不同区域（文本、列表、表格、卡片）有不同的拖动行为
3. **层级转换**：跨层级拖动时自动调整缩进和类型
4. **动画反馈**：拖动过程有明确的视觉反馈

---

## 二、拖动场景矩阵（72 种场景）

### A. 基础文本块拖动（12 种）

#### A1. 段落 → 段落
- **场景 1**: 段落拖到另一段落上方
  - **行为**: 插入到目标段落之前
  - **飞书**: 显示蓝线在目标段落上方
  - **Craft**: 目标段落上方显示插入指示器

- **场景 2**: 段落拖到另一段落下方
  - **行为**: 插入到目标段落之后
  - **飞书**: 显示蓝线在目标段落下方
  - **Craft**: 目标段落下方显示插入指示器

- **场景 3**: 段落拖到空白区域
  - **行为**: 在最近的块之后插入
  - **飞书**: 自动定位到最近的插入点
  - **Craft**: 创建新的段落块

#### A2. 标题 → 段落/标题
- **场景 4**: H1 拖到段落区域
  - **行为**: 保持 H1 格式，整块移动
  - **飞书**: 标题样式不变
  - **Craft**: 标题样式不变

- **场景 5**: H2 拖到 H1 下方
  - **行为**: 保持层级关系，H2 成为 H1 的子内容
  - **飞书**: 自动缩进，显示层级关系
  - **Craft**: 自动调整为 H1 的子标题

- **场景 6**: H3 拖到 H1 和 H2 之间
  - **行为**: 插入在两者之间，保持 H3 格式
  - **飞书**: 蓝线显示在 H1 和 H2 之间
  - **Craft**: 插入指示器显示在两者之间

#### A3. 引用块拖动
- **场景 7**: 引用块拖到段落区域
  - **行为**: 保持引用格式，整块移动
  - **飞书**: 引用块样式完整保留（灰色背景、左边竖线）
  - **Craft**: 引用卡片整体移动

- **场景 8**: 引用块拖到另一引用块内部
  - **行为**: 嵌套引用（如果支持）或拒绝
  - **飞书**: 不支持嵌套引用，拒绝操作
  - **Craft**: 合并到目标引用块末尾

- **场景 9**: 段落拖入引用块
  - **行为**: 段落转换为引用内容
  - **飞书**: 段落自动添加引用格式
  - **Craft**: 段落成为引用块的一部分

#### A4. 代码块拖动
- **场景 10**: 代码块拖到段落区域
  - **行为**: 保持代码格式，整块移动
  - **飞书**: 代码块完整移动（包括语言标识）
  - **Craft**: 代码卡片整体移动

- **场景 11**: 段落拖入代码块
  - **行为**: 拒绝或转换为代码内容
  - **飞书**: 不允许，拒绝操作
  - **Craft**: 不允许，拒绝操作

- **场景 12**: 代码块拖到代码块之间
  - **行为**: 独立插入，保持两个代码块
  - **飞书**: 蓝线显示在两个代码块之间
  - **Craft**: 插入指示器显示在两者之间

---

### B. 列表类拖动（18 种）

#### B1. 无序列表拖动
- **场景 13**: 列表项拖到同列表其他项之间
  - **行为**: 改变列表项顺序
  - **飞书**: 列表项重排，保持缩进
  - **Craft**: 列表项重排，保持层级

- **场景 14**: 列表项拖到列表外
  - **行为**: 转换为独立段落
  - **飞书**: 自动去除列表标记，变成段落
  - **Craft**: 变成独立的段落块

- **场景 15**: 段落拖入无序列表
  - **行为**: 转换为列表项
  - **飞书**: 自动添加 bullet 标记
  - **Craft**: 自动变成列表项

- **场景 16**: 子列表项拖到父级列表项上方
  - **行为**: 提升层级，变成父级项
  - **飞书**: 自动调整缩进，去除子级标识
  - **Craft**: 自动调整缩进

- **场景 17**: 列表项拖到另一列表项右侧（缩进）
  - **行为**: 变成子列表项
  - **飞书**: 自动增加缩进，显示层级关系
  - **Craft**: 自动嵌套到父项下

- **场景 18**: 整个列表块拖到段落区域
  - **行为**: 整个列表移动（包括所有子项）
  - **飞书**: 完整的列表结构移动
  - **Craft**: 列表卡片整体移动

#### B2. 有序列表拖动
- **场景 19**: 有序列表项改变顺序
  - **行为**: 自动重新编号
  - **飞书**: 编号自动调整（1, 2, 3...）
  - **Craft**: 编号自动调整

- **场景 20**: 有序列表项拖到无序列表
  - **行为**: 转换为无序列表项
  - **飞书**: 数字变成 bullet
  - **Craft**: 自动转换列表类型

- **场景 21**: 无序列表项拖到有序列表
  - **行为**: 转换为有序列表项
  - **飞书**: bullet 变成数字
  - **Craft**: 自动转换列表类型

- **场景 22**: 有序列表拖到段落之间
  - **行为**: 整个列表移动，保持编号
  - **飞书**: 列表完整移动
  - **Craft**: 列表卡片整体移动

#### B3. 任务列表拖动
- **场景 23**: 任务项拖到其他任务项之间
  - **行为**: 改变任务顺序
  - **飞书**: 复选框状态保持
  - **Craft**: 复选框状态保持

- **场景 24**: 任务项拖到普通列表
  - **行为**: 转换为普通列表项
  - **飞书**: 复选框变成 bullet
  - **Craft**: 去除复选框

- **场景 25**: 段落拖到任务列表
  - **行为**: 转换为任务项
  - **飞书**: 自动添加复选框
  - **Craft**: 自动添加复选框

- **场景 26**: 已完成任务拖到未完成任务之间
  - **行为**: 保持完成状态，改变顺序
  - **飞书**: 勾选状态保持
  - **Craft**: 勾选状态保持

#### B4. 多级列表拖动
- **场景 27**: 三级列表项拖到一级
  - **行为**: 提升到顶级，去除所有缩进
  - **飞书**: 自动调整层级
  - **Craft**: 自动调整层级

- **场景 28**: 一级列表项拖到三级位置
  - **行为**: 降级到三级，增加缩进
  - **飞书**: 自动增加缩进
  - **Craft**: 自动嵌套到父项下

- **场景 29**: 带子项的列表项拖动
  - **行为**: 整个树结构移动
  - **飞书**: 父项和所有子项一起移动
  - **Craft**: 完整的层级树移动

- **场景 30**: 列表项拖到兄弟项之间
  - **行为**: 保持层级，改变顺序
  - **飞书**: 同级排序
  - **Craft**: 同级排序

---

### C. 表格拖动（12 种）

#### C1. 表格整体拖动
- **场景 31**: 整个表格拖到段落区域
  - **行为**: 表格整体移动
  - **飞书**: 表格结构完整保留
  - **Craft**: 表格卡片整体移动

- **场景 32**: 表格拖到列表中
  - **行为**: 表格成为列表项的内容
  - **飞书**: 表格嵌入列表项
  - **Craft**: 表格成为列表项的一部分

- **场景 33**: 段落拖入表格区域
  - **行为**: 拒绝或插入到表格外
  - **飞书**: 不允许，蓝线显示在表格外
  - **Craft**: 不允许，插入到表格前/后

#### C2. 表格行拖动
- **场景 34**: 表格行内部拖动（排序）
  - **行为**: 改变行顺序
  - **飞书**: 行重排
  - **Craft**: 行重排

- **场景 35**: 表格行拖出表格
  - **行为**: 转换为段落或列表
  - **飞书**: 不支持，拒绝操作
  - **Craft**: 单元格内容变成段落

- **场景 36**: 段落拖入表格（创建新行）
  - **行为**: 拒绝或在表格后插入
  - **飞书**: 不支持，拒绝操作
  - **Craft**: 不支持，拒绝操作

#### C3. 表格单元格拖动
- **场景 37**: 单元格内文本拖动
  - **行为**: 单元格内部移动
  - **飞书**: 仅移动文本内容
  - **Craft**: 仅移动文本内容

- **场景 38**: 单元格拖到另一单元格
  - **行为**: 交换单元格内容
  - **飞书**: 不支持，拒绝操作
  - **Craft**: 不支持，拒绝操作

- **场景 39**: 表格列拖动（改变列顺序）
  - **行为**: 列重排
  - **飞书**: 支持列拖动
  - **Craft**: 支持列拖动

#### C4. 表格与其他元素
- **场景 40**: 列表拖入表格单元格
  - **行为**: 列表嵌入单元格
  - **飞书**: 支持，单元格内显示列表
  - **Craft**: 支持，单元格内显示列表

- **场景 41**: 图片拖入表格单元格
  - **行为**: 图片嵌入单元格
  - **飞书**: 支持，单元格内显示图片
  - **Craft**: 支持，单元格内显示图片

- **场景 42**: 表格拖到另一表格单元格
  - **行为**: 嵌套表格
  - **飞书**: 不支持，拒绝操作
  - **Craft**: 不支持，拒绝操作

---

### D. 媒体类拖动（9 种）

#### D1. 图片拖动
- **场景 43**: 图片拖到段落区域
  - **行为**: 图片整体移动
  - **飞书**: 图片块移动
  - **Craft**: 图片卡片移动

- **场景 44**: 段落拖到图片上方
  - **行为**: 插入在图片之前
  - **飞书**: 蓝线显示在图片上方
  - **Craft**: 插入指示器显示在图片上方

- **场景 45**: 图片拖到列表中
  - **行为**: 图片成为列表项
  - **飞书**: 图片嵌入列表项
  - **Craft**: 图片成为列表项的一部分

#### D2. 视频拖动
- **场景 46**: 视频块拖到段落区域
  - **行为**: 视频整体移动
  - **飞书**: 视频播放器移动
  - **Craft**: 视频卡片移动

- **场景 47**: 视频拖到引用块
  - **行为**: 视频嵌入引用块
  - **飞书**: 支持，视频在引用块内
  - **Craft**: 支持，视频在引用块内

- **场景 48**: 段落拖到视频和图片之间
  - **行为**: 插入在两者之间
  - **飞书**: 蓝线显示在两者之间
  - **Craft**: 插入指示器显示在两者之间

#### D3. 文件拖动
- **场景 49**: 文件块拖到段落区域
  - **行为**: 文件整体移动
  - **飞书**: 文件卡片移动
  - **Craft**: 文件附件移动

- **场景 50**: 文件拖到列表中
  - **行为**: 文件成为列表项
  - **飞书**: 文件嵌入列表项
  - **Craft**: 文件成为列表项的一部分

- **场景 51**: 多个文件一起拖动
  - **行为**: 所有文件一起移动
  - **飞书**: 选中的文件块批量移动
  - **Craft**: 选中的文件卡片批量移动

---

### E. 特殊块拖动（9 种）

#### E1. 折叠块（Details）拖动
- **场景 52**: 折叠块拖到段落区域
  - **行为**: 折叠块整体移动（包括隐藏内容）
  - **飞书**: 折叠状态保持
  - **Craft**: Toggle 块整体移动

- **场景 53**: 段落拖入折叠块内容区
  - **行为**: 段落成为折叠内容
  - **飞书**: 段落添加到折叠区域
  - **Craft**: 段落嵌入 Toggle 内容

- **场景 54**: 折叠块拖到列表中
  - **行为**: 折叠块成为列表项
  - **飞书**: 折叠块嵌入列表项
  - **Craft**: Toggle 成为列表项的一部分

#### E2. 数学公式拖动
- **场景 55**: 公式块拖到段落区域
  - **行为**: 公式整体移动
  - **飞书**: LaTeX 公式块移动
  - **Craft**: 公式块移动

- **场景 56**: 段落拖到公式块
  - **行为**: 拒绝或插入在公式外
  - **飞书**: 不允许，蓝线显示在公式外
  - **Craft**: 不允许，插入到公式前/后

- **场景 57**: 内联公式拖动
  - **行为**: 仅移动公式，不移动块
  - **飞书**: 公式作为文本片段移动
  - **Craft**: 公式作为文本片段移动

#### E3. Callout（提示框）拖动
- **场景 58**: Callout 拖到段落区域
  - **行为**: Callout 整体移动
  - **飞书**: 高亮框移动（包括图标和颜色）
  - **Craft**: Callout 卡片移动

- **场景 59**: 段落拖入 Callout
  - **行为**: 段落成为 Callout 内容
  - **飞书**: 段落添加到 Callout 内
  - **Craft**: 段落嵌入 Callout

- **场景 60**: Callout 拖到列表中
  - **行为**: Callout 成为列表项
  - **飞书**: Callout 嵌入列表项
  - **Craft**: Callout 成为列表项的一部分

---

### F. 跨容器拖动（6 种）

#### F1. 分栏拖动
- **场景 61**: 段落拖到分栏的另一列
  - **行为**: 段落跨栏移动
  - **飞书**: 不支持分栏
  - **Craft**: 段落移动到目标列

- **场景 62**: 整个分栏拖动
  - **行为**: 分栏整体移动
  - **飞书**: 不支持分栏
  - **Craft**: 分栏容器移动

#### F2. 页面/子页面拖动
- **场景 63**: 段落拖到子页面
  - **行为**: 段落移动到子页面
  - **飞书**: 支持跨页面拖动
  - **Craft**: 段落移动到子页面

- **场景 64**: 子页面拖到主页面
  - **行为**: 子页面提升为主页面块
  - **飞书**: 子页面嵌入主页面
  - **Craft**: 子页面链接嵌入主页面

#### F3. 嵌入内容拖动
- **场景 65**: 嵌入块（iframe）拖动
  - **行为**: 嵌入块整体移动
  - **飞书**: 嵌入内容移动
  - **Craft**: 嵌入卡片移动

- **场景 66**: 段落拖到嵌入块
  - **行为**: 拒绝或插入在嵌入块外
  - **飞书**: 不允许，蓝线显示在嵌入块外
  - **Craft**: 不允许，插入到嵌入块前/后

---

### G. 批量拖动（6 种）

#### G1. 多块选择拖动
- **场景 67**: 选中多个段落拖动
  - **行为**: 所有选中块一起移动
  - **飞书**: 批量移动，保持顺序
  - **Craft**: 批量移动，保持顺序

- **场景 68**: 选中不连续的块拖动
  - **行为**: 拒绝或只移动第一个
  - **飞书**: 不支持，拒绝操作
  - **Craft**: 不支持，拒绝操作

- **场景 69**: 选中包含列表和段落的混合块
  - **行为**: 所有块保持类型移动
  - **飞书**: 批量移动，类型不变
  - **Craft**: 批量移动，类型不变

#### G2. 跨类型批量拖动
- **场景 70**: 选中标题+段落+列表拖动
  - **行为**: 完整的结构移动
  - **飞书**: 保持层级关系移动
  - **Craft**: 保持层级关系移动

- **场景 71**: 选中父列表项（包含子项）拖动
  - **行为**: 整个树结构移动
  - **飞书**: 父项和所有子项一起移动
  - **Craft**: 完整的层级树移动

- **场景 72**: 选中包含表格的多块拖动
  - **行为**: 表格和其他块一起移动
  - **飞书**: 批量移动，表格结构保持
  - **Craft**: 批量移动，表格结构保持

---

## 三、拖动引擎核心功能需求

### 1. 节点识别系统
- 识别当前拖动的节点类型（段落、标题、列表、表格等）
- 识别目标区域的节点类型
- 识别节点的嵌套层级和父子关系

### 2. 位置计算系统
- 计算精确的插入位置（before/after/inside）
- 处理边界情况（第一个块、最后一个块、空文档）
- 处理嵌套层级的位置计算

### 3. 转换规则系统
- 定义跨类型拖动的转换规则
- 处理格式保持和格式转换
- 处理嵌套结构的扁平化和层级化

### 4. 视觉反馈系统
- 显示蓝色插入线（Drop Cursor）
- 高亮目标区域
- 显示拖动预览（Ghost Image）
- 显示禁止拖动的标识

### 5. 验证系统
- 验证拖动操作是否合法
- 拒绝不合法的拖动操作
- 提供错误提示

### 6. 事务系统
- 保证拖动操作的原子性
- 支持撤销/重做
- 处理拖动失败的回滚

---

## 四、优先级排序

### P0（核心场景，必须支持）
- 段落拖动（场景 1-3）
- 标题拖动（场景 4-6）
- 列表项拖动（场景 13-18）
- 整块拖动（场景 31, 43, 52）

### P1（常用场景，应该支持）
- 引用块拖动（场景 7-9）
- 代码块拖动（场景 10-12）
- 有序列表拖动（场景 19-22）
- 任务列表拖动（场景 23-26）
- 表格拖动（场景 31-36）

### P2（进阶场景，可以支持）
- 媒体拖动（场景 43-51）
- 特殊块拖动（场景 52-60）
- 批量拖动（场景 67-72）

### P3（复杂场景，后续支持）
- 跨容器拖动（场景 61-66）
- 多级列表复杂拖动（场景 27-30）
- 表格行列拖动（场景 34-42）

---

## 五、技术实现要点

### 1. ProseMirror Transform API
```typescript
// 删除节点
tr.delete(from, to)

// 插入节点
tr.insert(pos, node)

// 替换节点
tr.replaceWith(from, to, node)

// 设置节点属性
tr.setNodeMarkup(pos, type, attrs)
```

### 2. 节点位置计算
```typescript
// 获取节点位置
$pos.before(depth)  // 节点之前
$pos.after(depth)   // 节点之后
$pos.start(depth)   // 节点内容开始
$pos.end(depth)     // 节点内容结束
```

### 3. 节点深度遍历
```typescript
// 向上查找块级节点
while (depth > 0) {
  const node = $pos.node(depth)
  if (node.isBlock && node.type.name !== 'doc') {
    // 找到目标节点
    break
  }
  depth--
}
```

### 4. 列表层级处理
```typescript
// 提升列表项
liftListItem(listItemType)

// 降级列表项（增加缩进）
sinkListItem(listItemType)

// 包装为列表
wrapInList(listType)
```

---

## 六、下一步行动

1. ✅ 完成场景分析文档
2. ⏭️ 实现拖动引擎核心类
3. ⏭️ 实现节点识别和位置计算
4. ⏭️ 实现转换规则系统
5. ⏭️ 实现视觉反馈系统
6. ⏭️ 编写单元测试
7. ⏭️ 集成到编辑器

---

**文档版本**: 1.0  
**创建时间**: 2025-11-30  
**更新时间**: 2025-11-30
