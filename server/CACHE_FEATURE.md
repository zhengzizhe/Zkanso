# 文档缓存功能

## 功能说明

服务器现在会缓存每个文档的状态，当客户端连接时会自动发送缓存的文档数据。

## 实现细节

### 服务器端（Java）

1. **文档缓存**：
   - `docCache`: 存储文档ID到文档状态的映射
   - `docLastModified`: 记录文档最后更新时间

2. **缓存更新时机**：
   - 客户端发送 `join` 消息时，如果包含 `state`，更新缓存
   - 客户端发送 `operation` 消息时，如果包含 `document`，更新缓存

3. **缓存发送时机**：
   - 客户端连接时，如果有缓存，自动发送
   - 客户端发送 `sync` 请求时，返回缓存

### 客户端（TypeScript）

1. **连接时发送状态**：
   - WebSocket 连接成功后，发送 `join` 消息，包含当前文档状态
   - 同时发送 `sync` 请求，获取服务器缓存的文档状态

2. **接收同步数据**：
   - 接收 `sync` 消息，合并服务器返回的文档状态
   - 确保本地文档与服务器同步

3. **发送操作时包含状态**：
   - 每次发送操作时，同时发送完整的文档状态
   - 用于服务器更新缓存

## 工作流程

1. **客户端A连接**：
   - 发送 `join` + 本地文档状态
   - 发送 `sync` 请求
   - 服务器返回缓存（如果有）

2. **客户端A编辑**：
   - 发送 `operation` + 完整文档状态
   - 服务器更新缓存
   - 服务器转发操作给其他客户端

3. **客户端B连接**：
   - 发送 `join` + 本地文档状态
   - 服务器自动发送缓存
   - 客户端B接收并合并文档状态

4. **客户端B编辑**：
   - 发送 `operation` + 完整文档状态
   - 服务器更新缓存
   - 服务器转发操作给其他客户端

## 优势

- ✅ 新客户端连接时自动获取最新文档状态
- ✅ 多客户端编辑时保持同步
- ✅ 服务器作为单一数据源
- ✅ 支持离线后重新连接同步



