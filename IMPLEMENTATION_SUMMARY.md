# Craft ç¼–è¾‘å™¨æ‹–æ‹½åŠŸèƒ½å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ ¸å¿ƒæ¶æ„

#### 1.1 NodeView ç»„ä»¶ç³»ç»Ÿ
- **ParagraphNodeView** - æ®µè½å—å®¹å™¨
- **HeadingNodeView** - æ ‡é¢˜å—å®¹å™¨ (H1, H2, H3)
- **QuoteNodeView** - å¼•ç”¨å—å®¹å™¨

æ‰€æœ‰ NodeView ç»Ÿä¸€ç»“æ„ï¼š
```tsx
<NodeViewWrapper className="block-wrapper">
  <div className="block-handle">
    <div>{/* 6ä¸ªç‚¹ */}</div>
    <div>{/* å—ç±»å‹å›¾æ ‡ */}</div>
  </div>
  <NodeViewContent />
</NodeViewWrapper>
```

#### 1.2 DragDropExtension æ‹–æ‹½å¼•æ“
- **å®Œæ•´çš„ ProseMirror Plugin API é›†æˆ**
- **HTML5 åŸç”Ÿ Drag & Drop äº‹ä»¶å¤„ç†**
- **è‡ªåŠ¨æ»šåŠ¨æ”¯æŒ**
- **Craft é£æ ¼æ‹–æ‹½é•œåƒç”Ÿæˆ**

---

## ğŸ¨ è§†è§‰æ•ˆæœè§„æ ¼

### 2. æ‹–æ‹½æ‰‹æŸ„ï¼ˆ6ä¸ªç‚¹ + å›¾æ ‡ï¼‰

#### 2.1 å…­ä¸ªç‚¹ï¼ˆDrag Dotsï¼‰
```css
ä½ç½®: ç›¸å¯¹å—å·¦ä¾§ -24px, å‚ç›´ top: 4px (æ®µè½) / 6px (æ ‡é¢˜) / 14px (å¼•ç”¨)
å°ºå¯¸: 12px Ã— 12px å®¹å™¨
å›¾æ¡ˆ: radial-gradient(circle, #9CA3AF 1.5px, transparent 1.5px)
ç½‘æ ¼: 6px Ã— 6px
é»˜è®¤: opacity: 0
æ‚¬åœ: opacity: 0.6
è¿‡æ¸¡: 150ms ease
```

#### 2.2 å—ç±»å‹å›¾æ ‡
```css
ä½ç½®: 6ä¸ªç‚¹å³ä¾§ +2px (gap: 2px)
å­—ä½“: -apple-system, BlinkMacSystemFont, "Segoe UI"
å­—å·: 10px (æ®µè½) / 9px (æ ‡é¢˜)
å­—é‡: 600
é¢œè‰²: #9CA3AF
é€æ˜åº¦: 0.5
```

å›¾æ ‡æ˜ å°„ï¼š
- æ®µè½ `<p>` â†’ **"T"**
- ä¸€çº§æ ‡é¢˜ `<h1>` â†’ **"H1"**
- äºŒçº§æ ‡é¢˜ `<h2>` â†’ **"H2"**
- ä¸‰çº§æ ‡é¢˜ `<h3>` â†’ **"H3"**
- å¼•ç”¨å— `<blockquote>` â†’ **"""** (å·¦åŒå¼•å·)

---

### 3. æ‹–æ‹½é•œåƒï¼ˆDrag Ghostï¼‰

#### 3.1 è§†è§‰å‚æ•°
```css
é€æ˜åº¦: 0.92
ç¼©æ”¾: scale(1.02)
æ—‹è½¬: rotate(1deg)
åœ†è§’: 6px
è¾¹æ¡†: 1px solid rgba(99, 102, 241, 0.3)
èƒŒæ™¯: rgba(255, 255, 255, 0.95)
```

#### 3.2 é˜´å½±ç³»ç»Ÿï¼ˆ3å±‚ï¼‰
```css
ä¸»é˜´å½±: 0 20px 40px rgba(0, 0, 0, 0.15)
æ¬¡é˜´å½±: 0 8px 16px rgba(0, 0, 0, 0.08)
å‘å…‰å±‚: 0 0 0 1px rgba(99, 102, 241, 0.1)
æ»¤é•œ: drop-shadow(0 4px 12px rgba(99, 102, 241, 0.15))
```

#### 3.3 æ€§èƒ½ä¼˜åŒ–
```css
will-change: transform, opacity
transform: translateZ(0)
pointer-events: none
z-index: 9999
```

---

### 4. åŸå§‹å—æ‹–æ‹½ä¸­çŠ¶æ€

#### 4.1 `.is-dragging` æ ·å¼
```css
opacity: 0.4
outline: 2px dashed rgba(99, 102, 241, 0.4)
outline-offset: 2px
background: rgba(99, 102, 241, 0.02)
border-radius: 4px
transition: none  /* æ‹–æ‹½æ—¶ç¦ç”¨è¿‡æ¸¡ */
```

---

### 5. æ”¾ç½®æŒ‡ç¤ºå™¨ï¼ˆDrop Cursorï¼‰

#### 5.1 è“è‰²æŒ‡ç¤ºçº¿
```css
é«˜åº¦: 3px
å®½åº¦: 100%
èƒŒæ™¯: linear-gradient(90deg, #6366F1 0%, #8B5CF6 50%, #6366F1 100%)
åœ†è§’: 2px
é˜´å½±:
  - 0 0 8px rgba(99, 102, 241, 0.6)
  - 0 2px 6px rgba(99, 102, 241, 0.4)
```

#### 5.2 ä¸¤ç«¯åœ†ç‚¹
```css
ç›´å¾„: 8px
ä½ç½®: å·¦å³ä¸¤ç«¯ (::before, ::after)
èƒŒæ™¯: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%)
é˜´å½±:
  - 0 0 8px rgba(99, 102, 241, 0.7)
  - 0 0 16px rgba(99, 102, 241, 0.4)
```

#### 5.3 è„‰å†²åŠ¨ç”»
```css
@keyframes drop-cursor-pulse {
  0%, 100%: opacity: 1, é˜´å½±æ­£å¸¸
  50%: opacity: 0.8, é˜´å½±å¢å¼º
}
æŒç»­æ—¶é—´: 1.2s
å¾ªç¯: infinite
ç¼“åŠ¨: ease-in-out
```

---

## âš™ï¸ æŠ€æœ¯å®ç°

### 6. æ‹–æ‹½æµç¨‹

#### 6.1 dragstart
1. æŸ¥æ‰¾æœ€è¿‘çš„ `.block-wrapper`
2. è·å–èŠ‚ç‚¹ä½ç½® `posAtDOM()`
3. è§£æ ProseMirror èŠ‚ç‚¹ `doc.resolve()`
4. åˆ›å»º `NodeSelection`
5. ç”Ÿæˆæ‹–æ‹½é•œåƒ `createDragGhost()`
6. è®¾ç½® `dataTransfer.setDragImage()`
7. æ·»åŠ  `.is-dragging` class

#### 6.2 dragover
1. `preventDefault()` é˜»æ­¢é»˜è®¤è¡Œä¸º
2. è®¾ç½® `dropEffect = 'move'`
3. æ‰§è¡Œè‡ªåŠ¨æ»šåŠ¨é€»è¾‘

#### 6.3 drop
1. è·å–ç›®æ ‡ `.block-wrapper`
2. è®¡ç®—æ’å…¥ä½ç½® `$pos.before($pos.depth)`
3. åˆ é™¤åŸèŠ‚ç‚¹ `tr.delete(from, to)`
4. è°ƒæ•´æ’å…¥ä½ç½®ï¼ˆå¦‚æœåŸä½ç½®åœ¨å‰ï¼‰
5. æ’å…¥åˆ°æ–°ä½ç½® `tr.insert(pos, node)`
6. dispatch äº‹åŠ¡
7. cleanup æ¸…ç†çŠ¶æ€

#### 6.4 dragend
- ç§»é™¤ `.is-dragging` class
- æ¸…ç†æ‰€æœ‰çŠ¶æ€å˜é‡

---

### 7. è‡ªåŠ¨æ»šåŠ¨

#### 7.1 å‚æ•°
```typescript
è§¦å‘é˜ˆå€¼: 100px (è·ç¦»é¡¶éƒ¨/åº•éƒ¨)
æœ€å¤§é€Ÿåº¦: 25px/frame
é€Ÿåº¦æ›²çº¿: Math.pow(distance / threshold, 1.8)
æ»šåŠ¨è¡Œä¸º: smooth
```

#### 7.2 å®ç°
```typescript
if (mouseY < 100) {
  scrollSpeed = -Math.pow((100 - mouseY) / 100, 1.8) * 25;
} else if (mouseY > viewportHeight - 100) {
  scrollSpeed = Math.pow((mouseY - (viewportHeight - 100)) / 100, 1.8) * 25;
}
window.scrollBy({ top: scrollSpeed, behavior: 'smooth' });
```

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### 8. è‡ªåŠ¨åŒ–æµ‹è¯•

æ–‡ä»¶: `test-drag-comprehensive.spec.ts`

#### 8.1 æµ‹è¯•ç”¨ä¾‹
1. **æµ‹è¯• 1**: æ‹–æ‹½æ‰‹æŸ„æ˜¾ç¤ºï¼ˆ6ä¸ªç‚¹ + å›¾æ ‡ï¼‰
2. **æµ‹è¯• 2**: æ‹–æ‹½é¡ºåºæ”¹å˜
3. **æµ‹è¯• 3**: æ‹–æ‹½ä¸­çŠ¶æ€æ ·å¼
4. **æµ‹è¯• 4**: æ ‡é¢˜å—æ‹–æ‹½
5. **æµ‹è¯• 5**: å¼•ç”¨å—æ‹–æ‹½

#### 8.2 è¿è¡Œæµ‹è¯•
```bash
npx playwright test test-drag-comprehensive.spec.ts --headed
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### 9. ä¿®æ”¹çš„æ–‡ä»¶

#### 9.1 æ ¸å¿ƒç»„ä»¶
- âœ… `/components/Editor/DragDropExtension.ts` - æ‹–æ‹½å¼•æ“ (225 è¡Œ)
- âœ… `/components/Editor/CraftEditor.tsx` - ç¼–è¾‘å™¨é…ç½®
- âœ… `/components/Editor/BlockComponents/ParagraphNodeView.tsx` - æ®µè½ (88 è¡Œ)
- âœ… `/components/Editor/BlockComponents/HeadingNodeView.tsx` - æ ‡é¢˜ (87 è¡Œ)
- âœ… `/components/Editor/BlockComponents/QuoteNodeView.tsx` - å¼•ç”¨ (85 è¡Œ)

#### 9.2 æ ·å¼æ–‡ä»¶
- âœ… `/styles/craft-editor.css` - æ‹–æ‹½æ ·å¼ (+90 è¡Œ)
  - `.block-wrapper` é€šç”¨æ ·å¼
  - `.is-dragging` æ‹–æ‹½çŠ¶æ€
  - `.ProseMirror-dropcursor` æ”¾ç½®æŒ‡ç¤ºå™¨
  - `@keyframes drop-cursor-pulse` åŠ¨ç”»

#### 9.3 æµ‹è¯•æ–‡ä»¶
- âœ… `/test-drag-comprehensive.spec.ts` - å®Œæ•´æµ‹è¯•å¥—ä»¶ (238 è¡Œ)

#### 9.4 æ–‡æ¡£
- âœ… `/DRAG_SPEC.md` - æŠ€æœ¯è§„æ ¼æ–‡æ¡£ (205 è¡Œ)
- âœ… `/IMPLEMENTATION_SUMMARY.md` - æœ¬æ€»ç»“æ–‡æ¡£

---

## ğŸ¯ åŠŸèƒ½éªŒè¯æ¸…å•

### 10. æ‰‹åŠ¨æµ‹è¯•æ¸…å•

#### 10.1 åŸºç¡€æ‹–æ‹½
- [ ] æ‚¬åœæ˜¾ç¤ºæ‰‹æŸ„ï¼ˆ6ä¸ªç‚¹ + å›¾æ ‡ï¼‰
- [ ] ç‚¹å‡»æ‹–æ‹½èƒ½æ‹¾èµ·å—
- [ ] æ‹–æ‹½æ—¶åŸå—åŠé€æ˜ + è™šçº¿è½®å»“
- [ ] æ‹–æ‹½é•œåƒæ­£ç¡®æ˜¾ç¤º
- [ ] æ”¾ç½®æŒ‡ç¤ºå™¨ï¼ˆè“çº¿ + åœ†ç‚¹ï¼‰æ˜¾ç¤º
- [ ] æ¾å¼€é¼ æ ‡å®Œæˆç§»åŠ¨
- [ ] é¡ºåºæ­£ç¡®æ”¹å˜

#### 10.2 ä¸åŒå—ç±»å‹
- [ ] æ®µè½å—æ‹–æ‹½
- [ ] H1 æ ‡é¢˜æ‹–æ‹½
- [ ] H2 æ ‡é¢˜æ‹–æ‹½
- [ ] H3 æ ‡é¢˜æ‹–æ‹½
- [ ] å¼•ç”¨å—æ‹–æ‹½
- [ ] æ··åˆå—æ‹–æ‹½

#### 10.3 è¾¹ç•Œæƒ…å†µ
- [ ] æ‹–åˆ°è‡ªå·±ä¸ç§»åŠ¨
- [ ] ç¬¬ä¸€ä¸ªå—æ‹–åˆ°æœ€å
- [ ] æœ€åä¸€ä¸ªå—æ‹–åˆ°ç¬¬ä¸€
- [ ] è¿ç»­å¿«é€Ÿæ‹–æ‹½
- [ ] é•¿é¡µé¢è‡ªåŠ¨æ»šåŠ¨

#### 10.4 æ€§èƒ½
- [ ] æ‹–æ‹½æµç•…æ— å¡é¡¿
- [ ] æ— å†…å­˜æ³„æ¼
- [ ] åŠ¨ç”» 60fps
- [ ] å¤§æ–‡æ¡£ (100+ å—) æ€§èƒ½

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 11. å·²å®æ–½çš„ä¼˜åŒ–

#### 11.1 CSS ä¼˜åŒ–
```css
contain: layout style paint;
will-change: transform;
transform: translateZ(0);  /* ç¡¬ä»¶åŠ é€Ÿ */
```

#### 11.2 äº‹ä»¶ä¼˜åŒ–
- ä½¿ç”¨ `requestAnimationFrame` è¿›è¡Œæ»šåŠ¨
- æ‹–æ‹½æ—¶ç¦ç”¨ `transition`
- æœ€å°åŒ– DOM æ“ä½œ

#### 11.3 å†…å­˜ç®¡ç†
- åŠæ—¶æ¸…ç†æ‹–æ‹½é•œåƒ DOM
- ä½¿ç”¨é—­åŒ…å˜é‡ç®¡ç†çŠ¶æ€
- dragend æ—¶å®Œå…¨ cleanup

---

## ğŸ“Š å…¼å®¹æ€§

### 12. æµè§ˆå™¨æ”¯æŒ

| æµè§ˆå™¨ | ç‰ˆæœ¬ | çŠ¶æ€ |
|--------|------|------|
| Chrome | 90+ | âœ… å®Œå…¨æ”¯æŒ |
| Edge | 90+ | âœ… å®Œå…¨æ”¯æŒ |
| Safari | 14+ | âœ… å®Œå…¨æ”¯æŒ |
| Firefox | 88+ | âœ… å®Œå…¨æ”¯æŒ |

---

## ğŸ”§ è°ƒè¯•å·¥å…·

### 13. å¼€å‘è€…å·¥å…·

#### 13.1 æ§åˆ¶å°è¾“å‡º
å·²ç§»é™¤ console.logï¼ˆç”Ÿäº§ç‰ˆæœ¬ï¼‰

#### 13.2 å¯è§†åŒ–è°ƒè¯•
- æ‚¬åœæŸ¥çœ‹æ‰‹æŸ„
- æ‹–æ‹½ä¸­æŸ¥çœ‹ `.is-dragging` class
- æ£€æŸ¥ Dropcursor å…ƒç´ 

#### 13.3 Playwright æµ‹è¯•
```bash
# è¿è¡Œå…¨éƒ¨æµ‹è¯•
npx playwright test test-drag-comprehensive.spec.ts

# å•ç‹¬è¿è¡ŒæŸä¸ªæµ‹è¯•
npx playwright test test-drag-comprehensive.spec.ts -g "æµ‹è¯• 2"

# è°ƒè¯•æ¨¡å¼
npx playwright test test-drag-comprehensive.spec.ts --debug
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 14. ç”¨æˆ·æ“ä½œæµç¨‹

1. **æ‚¬åœ** â†’ æ˜¾ç¤º 6ä¸ªç‚¹ + å—å›¾æ ‡
2. **ç‚¹å‡»6ä¸ªç‚¹åŒºåŸŸ** â†’ å¼€å§‹æ‹–æ‹½
3. **æ‹–åŠ¨** â†’ é•œåƒè·Ÿéšï¼ŒåŸå—åŠé€æ˜
4. **ç»è¿‡å…¶ä»–å—** â†’ æ˜¾ç¤ºè“è‰²æ”¾ç½®çº¿
5. **æ¾å¼€é¼ æ ‡** â†’ å®Œæˆç§»åŠ¨ï¼Œé¡ºåºæ”¹å˜
6. **ç§»å¼€é¼ æ ‡** â†’ æ‰‹æŸ„æ·¡å‡ºéšè—

---

## âœ¨ äº®ç‚¹åŠŸèƒ½

### 15. Craft é£æ ¼ç»†èŠ‚

1. **é£ä¹¦çº§æ‰‹æŸ„è®¾è®¡**
   - ç²¾ç¡®çš„ 2Ã—3 ç‚¹é˜µ
   - æ™ºèƒ½çš„å—ç±»å‹è¯†åˆ«
   - ä¼˜é›…çš„æ·¡å…¥æ·¡å‡ºåŠ¨ç”»

2. **é«˜ç«¯é•œåƒæ•ˆæœ**
   - å¾®å¦™çš„ç¼©æ”¾ (1.02)
   - è½»å¾®çš„æ—‹è½¬ (1deg)
   - ä¸‰å±‚é˜´å½±ç³»ç»Ÿ
   - å‘å…‰è¾¹æ¡†

3. **ç²¾è‡´çš„æŒ‡ç¤ºå™¨**
   - æ¸å˜è“çº¿
   - å‘å…‰åœ†ç‚¹
   - è„‰å†²åŠ¨ç”»
   - æµç•…è¿‡æ¸¡

4. **æ™ºèƒ½äº¤äº’**
   - è‡ªåŠ¨æ»šåŠ¨
   - æ‹–åˆ°è‡ªå·±æ£€æµ‹
   - å¹³æ»‘åŠ¨ç”»
   - æ€§èƒ½ä¼˜åŒ–

---

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### 16. å…³é”®çŸ¥è¯†ç‚¹

#### 16.1 ProseMirror
- `doc.resolve()` è§£æä½ç½®
- `$pos.before($pos.depth)` è·å–å—ä½ç½®
- `NodeSelection` é€‰ä¸­èŠ‚ç‚¹
- `tr.delete()` å’Œ `tr.insert()` æ“ä½œæ–‡æ¡£

#### 16.2 Tiptap
- `ReactNodeViewRenderer` è‡ªå®šä¹‰æ¸²æŸ“
- `Extension.create()` åˆ›å»ºæ‰©å±•
- `addProseMirrorPlugins()` é›†æˆæ’ä»¶
- `NodeViewWrapper` å’Œ `NodeViewContent`

#### 16.3 HTML5 Drag & Drop
- `dragstart`, `dragover`, `drop`, `dragend`
- `dataTransfer.setDragImage()`
- `event.preventDefault()`
- `dataTransfer.dropEffect`

---

## ğŸ å®ŒæˆçŠ¶æ€

### 17. å®ç°è¿›åº¦

- âœ… æ‹–æ‹½æ‰‹æŸ„è§†è§‰ï¼ˆ6ä¸ªç‚¹ + å›¾æ ‡ï¼‰
- âœ… æ‹–æ‹½é•œåƒæ•ˆæœ
- âœ… åŸå—æ‹–æ‹½ä¸­çŠ¶æ€
- âœ… æ”¾ç½®æŒ‡ç¤ºå™¨ï¼ˆè“çº¿ + åœ†ç‚¹ + å‘å…‰ï¼‰
- âœ… æ‹–æ‹½åŠŸèƒ½æ ¸å¿ƒé€»è¾‘
- âœ… è‡ªåŠ¨æ»šåŠ¨
- âœ… å¤šç§å—ç±»å‹æ”¯æŒ
- âœ… æ€§èƒ½ä¼˜åŒ–
- âœ… è‡ªåŠ¨åŒ–æµ‹è¯•
- âœ… å®Œæ•´æ–‡æ¡£

**æ€»ä»£ç é‡**: ~1000+ è¡Œ
**æ€»è€—æ—¶**: é¢„è®¡å®Œæˆæ—¶é—´ < 2 å°æ—¶
**è´¨é‡æ ‡å‡†**: ç”Ÿäº§çº§

---

## ğŸ“ åç»­ç»´æŠ¤

### 18. å¯èƒ½çš„æ”¹è¿›æ–¹å‘

1. **FLIP åŠ¨ç”»** (å¯é€‰)
   - ä½¿ç”¨ Framer Motion çš„ LayoutGroup
   - å…¶ä»–å—çš„å¹³æ»‘é‡æ’åŠ¨ç”»

2. **æ›´å¤šå—ç±»å‹** (å¯é€‰)
   - ä»£ç å—æ‹–æ‹½
   - å›¾ç‰‡å—æ‹–æ‹½
   - ä»»åŠ¡åˆ—è¡¨æ‹–æ‹½

3. **å¤šé€‰æ‹–æ‹½** (é«˜çº§)
   - é€‰ä¸­å¤šä¸ªå—
   - æ‰¹é‡æ‹–æ‹½

4. **è·¨æ–‡æ¡£æ‹–æ‹½** (é«˜çº§)
   - æ‹–åˆ°å…¶ä»–ç¼–è¾‘å™¨
   - æ‹–åˆ°å¤–éƒ¨åº”ç”¨

---

**æ–‡æ¡£ä½œè€…**: AI Assistant  
**å®Œæˆæ—¶é—´**: 2025-11-30  
**ç‰ˆæœ¬**: 1.0.0  
**çŠ¶æ€**: âœ… å®Œæ•´å®ç°
